"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports._authFlow = exports.signInBot = exports.signInWithPassword = exports.sendCode = exports.signInUserWithQrCode = exports.signInUser = exports.checkAuthorization = exports.start = void 0;
const tl_1 = require("../tl");
const utils = __importStar(require("../Utils"));
const Helpers_1 = require("../Helpers");
const Password_1 = require("../Password");
const QR_CODE_TIMEOUT = 30000;
// region public methods
/** @hidden */
function start(client, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        if (!client.connected) {
            yield client.connect();
        }
        if (yield client.checkAuthorization()) {
            return;
        }
        const apiCredentials = {
            apiId: client.apiId,
            apiHash: client.apiHash,
        };
        yield _authFlow(client, apiCredentials, authParams);
    });
}
exports.start = start;
/** @hidden */
function checkAuthorization(client) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            yield client.invoke(new tl_1.Api.updates.GetState());
            return true;
        }
        catch (e) {
            return false;
        }
    });
}
exports.checkAuthorization = checkAuthorization;
/** @hidden */
function signInUser(client, apiCredentials, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        let phoneNumber;
        let phoneCodeHash;
        let isCodeViaApp = false;
        while (1) {
            try {
                if (typeof authParams.phoneNumber === "function") {
                    try {
                        phoneNumber = yield authParams.phoneNumber();
                    }
                    catch (err) {
                        if (err.errorMessage === "RESTART_AUTH_WITH_QR") {
                            return client.signInUserWithQrCode(apiCredentials, authParams);
                        }
                        throw err;
                    }
                }
                else {
                    phoneNumber = authParams.phoneNumber;
                }
                const sendCodeResult = yield client.sendCode(apiCredentials, phoneNumber, authParams.forceSMS);
                phoneCodeHash = sendCodeResult.phoneCodeHash;
                isCodeViaApp = sendCodeResult.isCodeViaApp;
                if (typeof phoneCodeHash !== "string") {
                    throw new Error("Failed to retrieve phone code hash");
                }
                break;
            }
            catch (err) {
                if (typeof authParams.phoneNumber !== "function") {
                    throw err;
                }
                const shouldWeStop = yield authParams.onError(err);
                if (shouldWeStop) {
                    throw new Error("AUTH_USER_CANCEL");
                }
            }
        }
        let phoneCode;
        let isRegistrationRequired = false;
        let termsOfService;
        while (1) {
            try {
                try {
                    phoneCode = yield authParams.phoneCode(isCodeViaApp);
                }
                catch (err) {
                    // This is the support for changing phone number from the phone code screen.
                    if (err.errorMessage === "RESTART_AUTH") {
                        return client.signInUser(apiCredentials, authParams);
                    }
                }
                if (!phoneCode) {
                    throw new Error("Code is empty");
                }
                // May raise PhoneCodeEmptyError, PhoneCodeExpiredError,
                // PhoneCodeHashEmptyError or PhoneCodeInvalidError.
                const result = yield client.invoke(new tl_1.Api.auth.SignIn({
                    phoneNumber,
                    phoneCodeHash,
                    phoneCode,
                }));
                if (result instanceof tl_1.Api.auth.AuthorizationSignUpRequired) {
                    isRegistrationRequired = true;
                    termsOfService = result.termsOfService;
                    break;
                }
                return result.user;
            }
            catch (err) {
                if (err.errorMessage === "SESSION_PASSWORD_NEEDED") {
                    return client.signInWithPassword(apiCredentials, authParams);
                }
                else {
                    const shouldWeStop = yield authParams.onError(err);
                    if (shouldWeStop) {
                        throw new Error("AUTH_USER_CANCEL");
                    }
                }
            }
        }
        if (isRegistrationRequired) {
            while (1) {
                try {
                    let lastName;
                    let firstName = "first name";
                    if (authParams.firstAndLastNames) {
                        const result = yield authParams.firstAndLastNames();
                        firstName = result[0];
                        lastName = result[1];
                    }
                    if (!firstName) {
                        throw new Error("First name is required");
                    }
                    const { user } = (yield client.invoke(new tl_1.Api.auth.SignUp({
                        phoneNumber,
                        phoneCodeHash,
                        firstName,
                        lastName,
                    })));
                    if (termsOfService) {
                        // This is a violation of Telegram rules: the user should be presented with and accept TOS.
                        yield client.invoke(new tl_1.Api.help.AcceptTermsOfService({
                            id: termsOfService.id,
                        }));
                    }
                    return user;
                }
                catch (err) {
                    const shouldWeStop = yield authParams.onError(err);
                    if (shouldWeStop) {
                        throw new Error("AUTH_USER_CANCEL");
                    }
                }
            }
        }
        yield authParams.onError(new Error("Auth failed"));
        return client.signInUser(apiCredentials, authParams);
    });
}
exports.signInUser = signInUser;
/** @hidden */
function signInUserWithQrCode(client, apiCredentials, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        const inputPromise = (() => __awaiter(this, void 0, void 0, function* () {
            while (1) {
                const result = yield client.invoke(new tl_1.Api.auth.ExportLoginToken({
                    apiId: Number(process.env.TELEGRAM_T_API_ID),
                    apiHash: process.env.TELEGRAM_T_API_HASH,
                    exceptIds: [],
                }));
                if (!(result instanceof tl_1.Api.auth.LoginToken)) {
                    throw new Error("Unexpected");
                }
                const { token, expires } = result;
                if (authParams.qrCode) {
                    yield Promise.race([
                        authParams.qrCode({ token, expires }),
                        Helpers_1.sleep(QR_CODE_TIMEOUT),
                    ]);
                }
            }
        }))();
        const updatePromise = new Promise((resolve) => {
            client.addEventHandler((update) => {
                if (update instanceof tl_1.Api.UpdateLoginToken) {
                    resolve(undefined);
                }
            });
        });
        try {
            yield Promise.race([updatePromise, inputPromise]);
        }
        catch (err) {
            if (err.errorMessage === "RESTART_AUTH") {
                return client.signInUser(apiCredentials, authParams);
            }
            throw err;
        }
        try {
            const result2 = yield client.invoke(new tl_1.Api.auth.ExportLoginToken({
                apiId: Number(process.env.TELEGRAM_T_API_ID),
                apiHash: process.env.TELEGRAM_T_API_HASH,
                exceptIds: [],
            }));
            if (result2 instanceof tl_1.Api.auth.LoginTokenSuccess &&
                result2.authorization instanceof tl_1.Api.auth.Authorization) {
                return result2.authorization.user;
            }
            else if (result2 instanceof tl_1.Api.auth.LoginTokenMigrateTo) {
                yield client._switchDC(result2.dcId);
                const migratedResult = yield client.invoke(new tl_1.Api.auth.ImportLoginToken({
                    token: result2.token,
                }));
                if (migratedResult instanceof tl_1.Api.auth.LoginTokenSuccess &&
                    migratedResult.authorization instanceof tl_1.Api.auth.Authorization) {
                    return migratedResult.authorization.user;
                }
            }
        }
        catch (err) {
            if (err.errorMessage === "SESSION_PASSWORD_NEEDED") {
                return client.signInWithPassword(apiCredentials, authParams);
            }
        }
        yield authParams.onError(new Error("QR auth failed"));
        return client.signInUser(apiCredentials, authParams);
    });
}
exports.signInUserWithQrCode = signInUserWithQrCode;
/** @hidden */
function sendCode(client, apiCredentials, phoneNumber, forceSMS = false) {
    return __awaiter(this, void 0, void 0, function* () {
        try {
            const { apiId, apiHash } = apiCredentials;
            const sendResult = yield client.invoke(new tl_1.Api.auth.SendCode({
                phoneNumber,
                apiId,
                apiHash,
                settings: new tl_1.Api.CodeSettings({}),
            }));
            // If we already sent a SMS, do not resend the phoneCode (hash may be empty)
            if (!forceSMS || sendResult.type instanceof tl_1.Api.auth.SentCodeTypeSms) {
                return {
                    phoneCodeHash: sendResult.phoneCodeHash,
                    isCodeViaApp: sendResult.type instanceof tl_1.Api.auth.SentCodeTypeApp,
                };
            }
            const resendResult = yield client.invoke(new tl_1.Api.auth.ResendCode({
                phoneNumber,
                phoneCodeHash: sendResult.phoneCodeHash,
            }));
            return {
                phoneCodeHash: resendResult.phoneCodeHash,
                isCodeViaApp: resendResult.type instanceof tl_1.Api.auth.SentCodeTypeApp,
            };
        }
        catch (err) {
            if (err.errorMessage === "AUTH_RESTART") {
                return client.sendCode(apiCredentials, phoneNumber, forceSMS);
            }
            else {
                throw err;
            }
        }
    });
}
exports.sendCode = sendCode;
/** @hidden */
function signInWithPassword(client, apiCredentials, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        while (1) {
            try {
                const passwordSrpResult = yield client.invoke(new tl_1.Api.account.GetPassword());
                const password = yield authParams.password(passwordSrpResult.hint);
                if (!password) {
                    throw new Error("Password is empty");
                }
                const passwordSrpCheck = yield Password_1.computeCheck(passwordSrpResult, password);
                const { user } = (yield client.invoke(new tl_1.Api.auth.CheckPassword({
                    password: passwordSrpCheck,
                })));
                return user;
            }
            catch (err) {
                const shouldWeStop = yield authParams.onError(err);
                if (shouldWeStop) {
                    throw new Error("AUTH_USER_CANCEL");
                }
            }
        }
        return undefined; // Never reached (TypeScript fix)
    });
}
exports.signInWithPassword = signInWithPassword;
/** @hidden */
function signInBot(client, apiCredentials, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        const { apiId, apiHash } = apiCredentials;
        let { botAuthToken } = authParams;
        if (!botAuthToken) {
            throw new Error("a valid BotToken is required");
        }
        if (typeof botAuthToken === "function") {
            let token;
            while (true) {
                token = yield botAuthToken();
                if (token) {
                    botAuthToken = token;
                    break;
                }
            }
        }
        const { user } = (yield client.invoke(new tl_1.Api.auth.ImportBotAuthorization({
            apiId,
            apiHash,
            botAuthToken,
        })));
        return user;
    });
}
exports.signInBot = signInBot;
/** @hidden */
function _authFlow(client, apiCredentials, authParams) {
    return __awaiter(this, void 0, void 0, function* () {
        const me = "phoneNumber" in authParams
            ? yield client.signInUser(apiCredentials, authParams)
            : yield client.signInBot(apiCredentials, authParams);
        client._log.info("Signed in successfully as " + utils.getDisplayName(me));
    });
}
exports._authFlow = _authFlow;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2dyYW1qcy9jbGllbnQvYXV0aC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsOEJBQTRCO0FBQzVCLGdEQUFrQztBQUNsQyx3Q0FBbUM7QUFDbkMsMENBQXNFO0FBc0R0RSxNQUFNLGVBQWUsR0FBRyxLQUFLLENBQUM7QUFFOUIsd0JBQXdCO0FBQ3hCLGNBQWM7QUFDZCxTQUFzQixLQUFLLENBQ3ZCLE1BQXNCLEVBQ3RCLFVBQTBDOztRQUUxQyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRTtZQUNuQixNQUFNLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUMxQjtRQUVELElBQUksTUFBTSxNQUFNLENBQUMsa0JBQWtCLEVBQUUsRUFBRTtZQUNuQyxPQUFPO1NBQ1Y7UUFFRCxNQUFNLGNBQWMsR0FBRztZQUNuQixLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUs7WUFDbkIsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPO1NBQzFCLENBQUM7UUFFRixNQUFNLFNBQVMsQ0FBQyxNQUFNLEVBQUUsY0FBYyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQ3hELENBQUM7Q0FBQTtBQWxCRCxzQkFrQkM7QUFDRCxjQUFjO0FBQ2QsU0FBc0Isa0JBQWtCLENBQUMsTUFBc0I7O1FBQzNELElBQUk7WUFDQSxNQUFNLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxRQUFHLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7WUFDaEQsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1IsT0FBTyxLQUFLLENBQUM7U0FDaEI7SUFDTCxDQUFDO0NBQUE7QUFQRCxnREFPQztBQUNELGNBQWM7QUFDZCxTQUFzQixVQUFVLENBQzVCLE1BQXNCLEVBQ3RCLGNBQThCLEVBQzlCLFVBQTBCOztRQUUxQixJQUFJ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