"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getDialogs = exports.iterDialogs = exports._DialogsIter = void 0;
const tl_1 = require("../tl");
const requestIter_1 = require("../requestIter");
const index_1 = require("../index");
const dialog_1 = require("../tl/custom/dialog");
const _MAX_CHUNK_SIZE = 100;
/**
 Get the key to get messages from a dialog.

 We cannot just use the message ID because channels share message IDs,
 and the peer ID is required to distinguish between them. But it is not
 necessary in small group chats and private chats.
 * @param {Api.TypePeer} [peer] the dialog peer
 * @param {number} [messageId] the message id
 * @return {[number,number]} the channel id and message id
 */
function _dialogMessageKey(peer, messageId) {
    // can't use arrays as keys for map :( need to convert to string.
    return ("" +
        [
            peer instanceof tl_1.Api.PeerChannel ? peer.channelId : undefined,
            messageId,
        ]);
}
class _DialogsIter extends requestIter_1.RequestIter {
    _init({ offsetDate, offsetId, offsetPeer, ignorePinned, ignoreMigrated, folder, }) {
        return __awaiter(this, void 0, void 0, function* () {
            this.request = new tl_1.Api.messages.GetDialogs({
                offsetDate,
                offsetId,
                offsetPeer,
                limit: 1,
                hash: 0,
                excludePinned: ignorePinned,
                folderId: folder,
            });
            if (this.limit <= 0) {
                // Special case, get a single dialog and determine count
                const dialogs = yield this.client.invoke(this.request);
                if ("count" in dialogs) {
                    this.total = dialogs.count;
                }
                else {
                    this.total = dialogs.dialogs.length;
                }
                return true;
            }
            this.seen = new Set();
            this.offsetDate = offsetDate;
            this.ignoreMigrated = ignoreMigrated;
        });
    }
    _loadNextChunk() {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.request || !this.seen || !this.buffer) {
                return;
            }
            this.request.limit = Math.min(this.left, _MAX_CHUNK_SIZE);
            const r = yield this.client.invoke(this.request);
            if (r instanceof tl_1.Api.messages.DialogsNotModified) {
                return;
            }
            if ("count" in r) {
                this.total = r.count;
            }
            else {
                this.total = r.dialogs.length;
            }
            const entities = new Map();
            const messages = new Map();
            for (const entity of [...r.users, ...r.chats]) {
                if (entity instanceof tl_1.Api.UserEmpty ||
                    entity instanceof tl_1.Api.ChatEmpty) {
                    continue;
                }
                entities.set(index_1.utils.getPeerId(entity), entity);
            }
            for (const m of r.messages) {
                let message = m;
                try {
                    // todo make sure this never fails
                    message._finishInit(this.client, entities, undefined);
                }
                catch (e) {
                    this.client._log.error("Got error while trying to finish init message with id " +
                        m.id);
                    if (this.client._log.canSend("error")) {
                        console.error(e);
                    }
                }
                messages.set(_dialogMessageKey(message.peerId, message.id), message);
            }
            for (const d of r.dialogs) {
                if (d instanceof tl_1.Api.DialogFolder) {
                    continue;
                }
                const message = messages.get(_dialogMessageKey(d.peer, d.topMessage));
                if (this.offsetDate != undefined) {
                    const date = message === null || message === void 0 ? void 0 : message.date;
                    if (date != undefined || date > this.offsetDate) {
                        continue;
                    }
                }
                const peerId = index_1.utils.getPeerId(d.peer);
                if (!this.seen.has(peerId)) {
                    this.seen.add(peerId);
                    if (!entities.has(peerId)) {
                        /*
                         > In which case can a UserEmpty appear in the list of banned members?
                         > In a very rare cases. This is possible but isn't an expected behavior.
                         Real world example: https://t.me/TelethonChat/271471
                         */
                        continue;
                    }
                    const cd = new dialog_1.Dialog(this.client, d, entities, message);
                    if (!this.ignoreMigrated ||
                        (cd.entity != undefined && "migratedTo" in cd.entity)) {
                        this.buffer.push(cd);
                    }
                }
            }
            if (r.dialogs.length < this.request.limit ||
                !(r instanceof tl_1.Api.messages.DialogsSlice)) {
                return true;
            }
            let lastMessage;
            for (let dialog of r.dialogs.reverse()) {
                lastMessage = messages.get(_dialogMessageKey(dialog.peer, dialog.topMessage));
                if (lastMessage) {
                    break;
                }
            }
            this.request.excludePinned = true;
            this.request.offsetId = lastMessage ? lastMessage.id : 0;
            this.request.offsetDate = lastMessage ? lastMessage.date : 0;
            this.request.offsetPeer =
                this.buffer[this.buffer.length - 1].inputEntity;
        });
    }
}
exports._DialogsIter = _DialogsIter;
/** @hidden */
function iterDialogs(client, { limit = undefined, offsetDate = undefined, offsetId = 0, offsetPeer = new tl_1.Api.InputPeerEmpty(), ignorePinned = false, ignoreMigrated = false, folder = undefined, archived = undefined, }) {
    if (archived != undefined) {
        folder = archived ? 1 : 0;
    }
    return new _DialogsIter(client, limit, {}, {
        offsetDate,
        offsetId,
        offsetPeer,
        ignorePinned,
        ignoreMigrated,
        folder,
    });
}
exports.iterDialogs = iterDialogs;
/** @hidden */
function getDialogs(client, params) {
    return __awaiter(this, void 0, void 0, function* () {
        return (yield client.iterDialogs(params).collect());
    });
}
exports.getDialogs = getDialogs;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9ncy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2dyYW1qcy9jbGllbnQvZGlhbG9ncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSw4QkFBNEI7QUFDNUIsZ0RBQTZDO0FBQzdDLG9DQUFpRDtBQUVqRCxnREFBNkM7QUFJN0MsTUFBTSxlQUFlLEdBQUcsR0FBRyxDQUFDO0FBRTVCOzs7Ozs7Ozs7R0FTRztBQUNILFNBQVMsaUJBQWlCLENBQUMsSUFBa0IsRUFBRSxTQUFpQjtJQUM1RCxpRUFBaUU7SUFDakUsT0FBTyxDQUNILEVBQUU7UUFDRjtZQUNJLElBQUksWUFBWSxRQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTO1lBQzVELFNBQVM7U0FDWixDQUNKLENBQUM7QUFDTixDQUFDO0FBV0QsTUFBYSxZQUFhLFNBQVEseUJBQVc7SUFNbkMsS0FBSyxDQUFDLEVBQ1IsVUFBVSxFQUNWLFFBQVEsRUFDUixVQUFVLEVBQ1YsWUFBWSxFQUNaLGNBQWMsRUFDZCxNQUFNLEdBQ2E7O1lBQ25CLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxRQUFHLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQztnQkFDdkMsVUFBVTtnQkFDVixRQUFRO2dCQUNSLFVBQVU7Z0JBQ1YsS0FBSyxFQUFFLENBQUM7Z0JBQ1IsSUFBSSxFQUFFLENBQUM7Z0JBQ1AsYUFBYSxFQUFFLFlBQVk7Z0JBQzNCLFFBQVEsRUFBRSxNQUFNO2FBQ25CLENBQUMsQ0FBQztZQUNILElBQUksSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLEVBQUU7Z0JBQ2pCLHdEQUF3RDtnQkFDeEQsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ3ZELElBQUksT0FBTyxJQUFJLE9BQU8sRUFBRTtvQkFD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