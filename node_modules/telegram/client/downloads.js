"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.downloadProfilePhoto = exports._downloadPhoto = exports._downloadCachedPhotoSize = exports._downloadWebDocument = exports._downloadContact = exports._downloadDocument = exports.downloadMedia = exports.downloadFile = void 0;
const tl_1 = require("../tl");
const Utils_1 = require("../Utils");
const Helpers_1 = require("../Helpers");
const __1 = require("../");
// All types
const sizeTypes = ["w", "y", "d", "x", "c", "m", "b", "a", "s"];
// Chunk sizes for `upload.getFile` must be multiple of the smallest size
const MIN_CHUNK_SIZE = 4096;
const DEFAULT_CHUNK_SIZE = 64; // kb
const ONE_MB = 1024 * 1024;
const REQUEST_TIMEOUT = 15000;
/** @hidden */
function downloadFile(client, inputLocation, fileParams) {
    return __awaiter(this, void 0, void 0, function* () {
        let { partSizeKb, fileSize, workers = 1, end } = fileParams;
        const { dcId, progressCallback, start = 0 } = fileParams;
        end = end && end < fileSize ? end : fileSize - 1;
        if (!partSizeKb) {
            partSizeKb = fileSize
                ? Utils_1.getAppropriatedPartSize(fileSize)
                : DEFAULT_CHUNK_SIZE;
        }
        const partSize = partSizeKb * 1024;
        const partsCount = end ? Math.ceil((end - start) / partSize) : 1;
        if (partSize % MIN_CHUNK_SIZE !== 0) {
            throw new Error(`The part size must be evenly divisible by ${MIN_CHUNK_SIZE}`);
        }
        let sender;
        if (dcId) {
            try {
                sender = yield client._borrowExportedSender(dcId);
                client._log.debug(`Finished creating sender for ${dcId}`);
            }
            catch (e) {
                // This should never raise
                if (e.errorMessage === "DC_ID_INVALID") {
                    // Can't export a sender for the ID we are currently in
                    sender = client._sender;
                }
                else {
                    client._log.error(e);
                    throw e;
                }
            }
        }
        else {
            sender = client._sender;
        }
        client._log.info(`Downloading file in chunks of ${partSize} bytes`);
        const foreman = new Foreman(workers);
        const promises = [];
        let offset = start;
        // Used for files with unknown size and for manual cancellations
        let hasEnded = false;
        let progress = 0;
        if (progressCallback) {
            progressCallback(progress);
        }
        while (true) {
            let limit = partSize;
            let isPrecise = false;
            if (Math.floor(offset / ONE_MB) !==
                Math.floor((offset + limit - 1) / ONE_MB)) {
                limit = ONE_MB - (offset % ONE_MB);
                isPrecise = true;
            }
            yield foreman.requestWorker();
            if (hasEnded) {
                yield foreman.releaseWorker();
                break;
            }
            promises.push((() => __awaiter(this, void 0, void 0, function* () {
                try {
                    const result = yield Promise.race([
                        yield sender.send(new tl_1.Api.upload.GetFile({
                            location: inputLocation,
                            offset,
                            limit,
                            precise: isPrecise || undefined,
                        })),
                        Helpers_1.sleep(REQUEST_TIMEOUT).then(() => Promise.reject(new Error("REQUEST_TIMEOUT"))),
                    ]);
                    if (progressCallback) {
                        if (progressCallback.isCanceled) {
                            throw new Error("USER_CANCELED");
                        }
                        progress += 1 / partsCount;
                        progressCallback(progress);
                    }
                    if (!end && result.bytes.length < limit) {
                        hasEnded = true;
                    }
                    return result.bytes;
                }
                catch (err) {
                    hasEnded = true;
                    throw err;
                }
                finally {
                    foreman.releaseWorker();
                }
            }))());
            offset += limit;
            if (end && offset > end) {
                break;
            }
        }
        const results = yield Promise.all(promises);
        const buffers = results.filter(Boolean);
        const totalLength = end ? end + 1 - start : undefined;
        return Buffer.concat(buffers, totalLength);
    });
}
exports.downloadFile = downloadFile;
class Foreman {
    constructor(maxWorkers) {
        this.maxWorkers = maxWorkers;
        this.activeWorkers = 0;
    }
    requestWorker() {
        this.activeWorkers++;
        if (this.activeWorkers > this.maxWorkers) {
            this.deferred = createDeferred();
            return this.deferred.promise;
        }
        return Promise.resolve();
    }
    releaseWorker() {
        this.activeWorkers--;
        if (this.deferred && this.activeWorkers <= this.maxWorkers) {
            this.deferred.resolve();
        }
    }
}
function createDeferred() {
    let resolve;
    const promise = new Promise((_resolve) => {
        resolve = _resolve;
    });
    return {
        promise,
        resolve: resolve,
    };
}
/** @hidden */
function downloadMedia(client, messageOrMedia, downloadParams) {
    return __awaiter(this, void 0, void 0, function* () {
        let date;
        let media;
        if (messageOrMedia instanceof tl_1.Api.Message) {
            media = messageOrMedia.media;
        }
        else {
            media = messageOrMedia;
        }
        if (typeof media == "string") {
            throw new Error("not implemented");
        }
        if (media instanceof tl_1.Api.MessageMediaWebPage) {
            if (media.webpage instanceof tl_1.Api.WebPage) {
                media = media.webpage.document || media.webpage.photo;
            }
        }
        if (media instanceof tl_1.Api.MessageMediaPhoto || media instanceof tl_1.Api.Photo) {
            return _downloadPhoto(client, media, downloadParams);
        }
        else if (media instanceof tl_1.Api.MessageMediaDocument ||
            media instanceof tl_1.Api.Document) {
            return _downloadDocument(client, media, downloadParams);
        }
        else if (media instanceof tl_1.Api.MessageMediaContact) {
            return _downloadContact(client, media, downloadParams);
        }
        else if (media instanceof tl_1.Api.WebDocument ||
            media instanceof tl_1.Api.WebDocumentNoProxy) {
            return _downloadWebDocument(client, media, downloadParams);
        }
        else {
            return Buffer.alloc(0);
        }
    });
}
exports.downloadMedia = downloadMedia;
function _downloadDocument(client, doc, args) {
    return __awaiter(this, void 0, void 0, function* () {
        if (doc instanceof tl_1.Api.MessageMediaDocument) {
            if (!doc.document) {
                return Buffer.alloc(0);
            }
            doc = doc.document;
        }
        if (!(doc instanceof tl_1.Api.Document)) {
            return Buffer.alloc(0);
        }
        let size = undefined;
        if (args.sizeType) {
            size = doc.thumbs ? pickFileSize(doc.thumbs, args.sizeType) : undefined;
            if (!size && doc.mimeType.startsWith("video/")) {
                return Buffer.alloc(0);
            }
            if (size &&
                (size instanceof tl_1.Api.PhotoCachedSize ||
                    size instanceof tl_1.Api.PhotoStrippedSize)) {
                return _downloadCachedPhotoSize(size);
            }
        }
        return client.downloadFile(new tl_1.Api.InputDocumentFileLocation({
            id: doc.id,
            accessHash: doc.accessHash,
            fileReference: doc.fileReference,
            thumbSize: size ? size.type : "",
        }), {
            fileSize: size && !(size instanceof tl_1.Api.PhotoSizeEmpty)
                ? size instanceof tl_1.Api.PhotoSizeProgressive
                    ? Math.max(...size.sizes)
                    : size.size
                : doc.size,
            progressCallback: args.progressCallback,
            start: args.start,
            end: args.end,
            dcId: doc.dcId,
            workers: args.workers,
        });
    });
}
exports._downloadDocument = _downloadDocument;
function _downloadContact(client, media, args) {
    return __awaiter(this, void 0, void 0, function* () {
        throw new Error("not implemented");
    });
}
exports._downloadContact = _downloadContact;
function _downloadWebDocument(client, media, args) {
    return __awaiter(this, void 0, void 0, function* () {
        throw new Error("not implemented");
    });
}
exports._downloadWebDocument = _downloadWebDocument;
function pickFileSize(sizes, sizeType) {
    if (!sizeType || !sizes || !sizes.length) {
        return undefined;
    }
    const indexOfSize = sizeTypes.indexOf(sizeType);
    let size;
    for (let i = indexOfSize; i < sizeTypes.length; i++) {
        size = sizes.find((s) => s.type === sizeTypes[i]);
        if (size && !(size instanceof tl_1.Api.PhotoPathSize)) {
            return size;
        }
    }
    return undefined;
}
function _downloadCachedPhotoSize(size) {
    // No need to download anything, simply write the bytes
    let data;
    if (size instanceof tl_1.Api.PhotoStrippedSize) {
        data = Utils_1.strippedPhotoToJpg(size.bytes);
    }
    else {
        data = size.bytes;
    }
    return data;
}
exports._downloadCachedPhotoSize = _downloadCachedPhotoSize;
function _downloadPhoto(client, photo, args) {
    return __awaiter(this, void 0, void 0, function* () {
        if (photo instanceof tl_1.Api.MessageMediaPhoto) {
            if (photo.photo instanceof tl_1.Api.PhotoEmpty || !photo.photo) {
                return Buffer.alloc(0);
            }
            photo = photo.photo;
        }
        if (!(photo instanceof tl_1.Api.Photo)) {
            return Buffer.alloc(0);
        }
        const size = pickFileSize(photo.sizes, args.sizeType || sizeTypes[0]);
        if (!size || size instanceof tl_1.Api.PhotoSizeEmpty) {
            return Buffer.alloc(0);
        }
        if (size instanceof tl_1.Api.PhotoCachedSize ||
            size instanceof tl_1.Api.PhotoStrippedSize) {
            return _downloadCachedPhotoSize(size);
        }
        return client.downloadFile(new tl_1.Api.InputPhotoFileLocation({
            id: photo.id,
            accessHash: photo.accessHash,
            fileReference: photo.fileReference,
            thumbSize: size.type,
        }), {
            dcId: photo.dcId,
            fileSize: size instanceof tl_1.Api.PhotoSizeProgressive
                ? Math.max(...size.sizes)
                : size.size,
            progressCallback: args.progressCallback,
        });
    });
}
exports._downloadPhoto = _downloadPhoto;
/** @hidden */
function downloadProfilePhoto(client, entity, fileParams) {
    return __awaiter(this, void 0, void 0, function* () {
        entity = yield client.getEntity(entity);
        let photo;
        if ("photo" in entity) {
            photo = entity.photo;
        }
        else {
            throw new Error(`Could not get photo from ${entity ? entity.className : undefined}`);
        }
        let dcId;
        let loc;
        if (photo instanceof tl_1.Api.UserProfilePhoto ||
            photo instanceof tl_1.Api.ChatPhoto) {
            dcId = photo.dcId;
            loc = new tl_1.Api.InputPeerPhotoFileLocation({
                peer: __1.utils.getInputPeer(entity),
                photoId: photo.photoId,
                big: fileParams.isBig,
            });
        }
        else {
            return Buffer.alloc(0);
        }
        return client.downloadFile(loc, {
            dcId,
            fileSize: 2 * 1024 * 1024,
            workers: 1,
        });
    });
}
exports.downloadProfilePhoto = downloadProfilePhoto;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG93bmxvYWRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vZ3JhbWpzL2NsaWVudC9kb3dubG9hZHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUEsOEJBQTRCO0FBRTVCLG9DQUF1RTtBQUN2RSx3Q0FBbUM7QUFJbkMsMkJBQTRCO0FBb0Q1QixZQUFZO0FBQ1osTUFBTSxTQUFTLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBRWhFLHlFQUF5RTtBQUN6RSxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUM7QUFDNUIsTUFBTSxrQkFBa0IsR0FBRyxFQUFFLENBQUMsQ0FBQyxLQUFLO0FBQ3BDLE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUM7QUFDM0IsTUFBTSxlQUFlLEdBQUcsS0FBSyxDQUFDO0FBRTlCLGNBQWM7QUFDZCxTQUFzQixZQUFZLENBQzlCLE1BQXNCLEVBQ3RCLGFBQXdDLEVBQ3hDLFVBQThCOztRQUU5QixJQUFJLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxPQUFPLEdBQUcsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLFVBQVUsQ0FBQztRQUM1RCxNQUFNLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixFQUFFLEtBQUssR0FBRyxDQUFDLEVBQUUsR0FBRyxVQUFVLENBQUM7UUFFekQsR0FBRyxHQUFHLEdBQUcsSUFBSSxHQUFHLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFFakQsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNiLFVBQVUsR0FBRyxRQUFRO2dCQUNqQixDQUFDLENBQUMsK0JBQXVCLENBQUMsUUFBUSxDQUFDO2dCQUNuQyxDQUFDLENBQUMsa0JBQWtCLENB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