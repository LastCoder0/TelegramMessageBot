"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.sendFile = exports.uploadFile = exports.CustomFile = void 0;
const tl_1 = require("../tl");
const Helpers_1 = require("../Helpers");
const Utils_1 = require("../Utils");
const path_1 = __importDefault(require("path"));
const fs_1 = require("fs");
const index_1 = require("../index");
const messageParse_1 = require("./messageParse");
/**
 * A custom file class that mimics the browser's File class.<br/>
 * You should use this whenever you want to upload a file.
 */
class CustomFile {
    constructor(name, size, path, buffer) {
        this.name = name;
        this.size = size;
        this.path = path;
        this.buffer = buffer;
    }
}
exports.CustomFile = CustomFile;
const KB_TO_BYTES = 1024;
const LARGE_FILE_THRESHOLD = 10 * 1024 * 1024;
const UPLOAD_TIMEOUT = 15 * 1000;
/** @hidden */
function uploadFile(client, fileParams) {
    return __awaiter(this, void 0, void 0, function* () {
        const { file, onProgress } = fileParams;
        let { workers } = fileParams;
        const { name, size } = file;
        const fileId = Helpers_1.readBigIntFromBuffer(Helpers_1.generateRandomBytes(8), true, true);
        const isLarge = size > LARGE_FILE_THRESHOLD;
        const partSize = Utils_1.getAppropriatedPartSize(size) * KB_TO_BYTES;
        const partCount = Math.floor((size + partSize - 1) / partSize);
        const buffer = Buffer.from(yield fileToBuffer(file));
        // We always upload from the DC we are in.
        const sender = yield client._borrowExportedSender(client.session.dcId);
        if (!workers || !size) {
            workers = 1;
        }
        if (workers >= partCount) {
            workers = partCount;
        }
        let progress = 0;
        if (onProgress) {
            onProgress(progress);
        }
        for (let i = 0; i < partCount; i += workers) {
            let sendingParts = [];
            let end = i + workers;
            if (end > partCount) {
                end = partCount;
            }
            for (let j = i; j < end; j++) {
                const bytes = buffer.slice(j * partSize, (j + 1) * partSize);
                sendingParts.push((() => __awaiter(this, void 0, void 0, function* () {
                    yield sender.send(isLarge
                        ? new tl_1.Api.upload.SaveBigFilePart({
                            fileId,
                            filePart: j,
                            fileTotalParts: partCount,
                            bytes,
                        })
                        : new tl_1.Api.upload.SaveFilePart({
                            fileId,
                            filePart: j,
                            bytes,
                        }));
                    if (onProgress) {
                        if (onProgress.isCanceled) {
                            throw new Error("USER_CANCELED");
                        }
                        progress += 1 / partCount;
                        onProgress(progress);
                    }
                }))());
            }
            try {
                yield Promise.race([
                    yield Promise.all(sendingParts),
                    Helpers_1.sleep(UPLOAD_TIMEOUT * workers).then(() => Promise.reject(new Error("TIMEOUT"))),
                ]);
            }
            catch (err) {
                if (err.error === "TIMEOUT") {
                    console.warn("Upload timeout. Retrying...");
                    i -= workers;
                    continue;
                }
                throw err;
            }
        }
        return isLarge
            ? new tl_1.Api.InputFileBig({
                id: fileId,
                parts: partCount,
                name,
            })
            : new tl_1.Api.InputFile({
                id: fileId,
                parts: partCount,
                name,
                md5Checksum: "", // This is not a "flag", so not sure if we can make it optional.
            });
    });
}
exports.uploadFile = uploadFile;
function _fileToMedia(client, { file, forceDocument, fileSize, progressCallback, attributes, thumb, voiceNote = false, videoNote = false, supportsStreaming = false, mimeType, asImage, workers = 1, }) {
    return __awaiter(this, void 0, void 0, function* () {
        if (!file) {
            return { fileHandle: undefined, media: undefined, image: undefined };
        }
        const isImage = index_1.utils.isImage(file);
        if (asImage == undefined) {
            asImage = isImage && !forceDocument;
        }
        if (typeof file == "object" &&
            !Buffer.isBuffer(file) &&
            !(file instanceof tl_1.Api.InputFile) &&
            !(file instanceof tl_1.Api.InputFileBig) &&
            !("read" in file)) {
            try {
                return {
                    fileHandle: undefined,
                    media: index_1.utils.getInputMedia(file, {
                        isPhoto: asImage,
                        attributes: attributes,
                        forceDocument: forceDocument,
                        voiceNote: voiceNote,
                        videoNote: videoNote,
                        supportsStreaming: supportsStreaming,
                    }),
                    image: asImage,
                };
            }
            catch (e) {
                return {
                    fileHandle: undefined,
                    media: undefined,
                    image: isImage,
                };
            }
        }
        let media;
        let fileHandle;
        let createdFile;
        if (file instanceof tl_1.Api.InputFile || file instanceof tl_1.Api.InputFileBig) {
            fileHandle = file;
        }
        else if (!(typeof file == "string") || (yield fs_1.promises.lstat(file)).isFile()) {
            if (typeof file == "string") {
                createdFile = new CustomFile(path_1.default.basename(file), (yield fs_1.promises.stat(file)).size, file);
            }
            else if (typeof File !== "undefined" && file instanceof File) {
                createdFile = file;
            }
            else {
                let name;
                if ("name" in file) {
                    // @ts-ignore
                    name = file.name;
                }
                else {
                    name = "unnamed";
                }
                if (file instanceof Buffer) {
                    createdFile = new CustomFile(name, file.length, "", file);
                }
            }
            if (!createdFile) {
                throw new Error(`Could not create file from ${JSON.stringify(file)}`);
            }
            fileHandle = yield uploadFile(client, {
                file: createdFile,
                onProgress: progressCallback,
                workers: workers,
            });
        }
        else if (file.startsWith("https://") || file.startsWith("http://")) {
            if (asImage) {
                media = new tl_1.Api.InputMediaPhotoExternal({ url: file });
            }
            else {
                media = new tl_1.Api.InputMediaPhotoExternal({ url: file });
            }
        }
        else {
            throw new Error(`"Not a valid path nor a url ${file}`);
        }
        if (media != undefined) {
        }
        else if (fileHandle == undefined) {
            throw new Error(`Failed to convert ${file} to media. Not an existing file or an HTTP URL`);
        }
        else if (asImage) {
            media = new tl_1.Api.InputMediaUploadedPhoto({
                file: fileHandle,
            });
        }
        else {
            // @ts-ignore
            let res = index_1.utils.getAttributes(file, {
                mimeType: mimeType,
                attributes: attributes,
                forceDocument: forceDocument && !isImage,
                voiceNote: voiceNote,
                videoNote: videoNote,
                supportsStreaming: supportsStreaming,
                thumb: thumb,
            });
            attributes = res.attrs;
            mimeType = res.mimeType;
            let uploadedThumb;
            if (!thumb) {
                uploadedThumb = undefined;
            }
            else {
                // todo refactor
                if (typeof thumb == "string") {
                    uploadedThumb = new CustomFile(path_1.default.basename(thumb), (yield fs_1.promises.stat(thumb)).size, thumb);
                }
                else if (typeof File !== "undefined" && thumb instanceof File) {
                    uploadedThumb = thumb;
                }
                else {
                    let name;
                    if ("name" in thumb) {
                        name = thumb.name;
                    }
                    else {
                        name = "unnamed";
                    }
                    if (thumb instanceof Buffer) {
                        uploadedThumb = new CustomFile(name, thumb.length, "", thumb);
                    }
                }
                if (!uploadedThumb) {
                    throw new Error(`Could not create file from ${file}`);
                }
                uploadedThumb = yield uploadFile(client, {
                    file: uploadedThumb,
                    workers: 1,
                });
            }
            media = new tl_1.Api.InputMediaUploadedDocument({
                file: fileHandle,
                mimeType: mimeType,
                attributes: attributes,
                thumb: uploadedThumb,
                forceFile: forceDocument && !isImage,
            });
        }
        return {
            fileHandle: fileHandle,
            media: media,
            image: asImage,
        };
    });
}
function sendFile(client, entity, { file, caption, forceDocument = false, fileSize, clearDraft = false, progressCallback, replyTo, attributes, thumb, parseMode, formattingEntities, voiceNote = false, videoNote = false, buttons, silent, supportsStreaming = false, scheduleDate, workers = 1, }) {
    return __awaiter(this, void 0, void 0, function* () {
        if (!file) {
            throw new Error("You need to specify a file");
        }
        if (!caption) {
            caption = "";
        }
        entity = yield client.getInputEntity(entity);
        replyTo = index_1.utils.getMessageId(replyTo);
        // TODO support albums in the future
        let msgEntities;
        if (formattingEntities != undefined) {
            msgEntities = formattingEntities;
        }
        else {
            [caption, msgEntities] = yield messageParse_1._parseMessageText(client, caption, parseMode);
        }
        const { fileHandle, media, image } = yield _fileToMedia(client, {
            file: file,
            forceDocument: forceDocument,
            fileSize: fileSize,
            progressCallback: progressCallback,
            attributes: attributes,
            thumb: thumb,
            voiceNote: voiceNote,
            videoNote: videoNote,
            supportsStreaming: supportsStreaming,
            workers: workers,
        });
        if (media == undefined) {
            throw new Error(`Cannot use ${file} as file.`);
        }
        const markup = client.buildReplyMarkup(buttons);
        const request = new tl_1.Api.messages.SendMedia({
            peer: entity,
            media: media,
            replyToMsgId: replyTo,
            message: caption,
            entities: msgEntities,
            replyMarkup: markup,
            silent: silent,
            scheduleDate: scheduleDate,
            clearDraft: clearDraft,
        });
        const result = yield client.invoke(request);
        return client._getResponseMessage(request, result, entity);
    });
}
exports.sendFile = sendFile;
function fileToBuffer(file) {
    if (typeof File !== "undefined" && file instanceof File) {
        return new Response(file).arrayBuffer();
    }
    else if (file instanceof CustomFile) {
        if (file.buffer != undefined) {
            return file.buffer;
        }
        else {
            return fs_1.promises.readFile(file.path);
        }
    }
    else {
        throw new Error("Could not create buffer from file " + file);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2Fkcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2dyYW1qcy9jbGllbnQvdXBsb2Fkcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFBQSw4QkFBNEI7QUFJNUIsd0NBQThFO0FBQzlFLG9DQUFtRDtBQUVuRCxnREFBd0I7QUFDeEIsMkJBQW9DO0FBQ3BDLG9DQUFpQztBQUNqQyxpREFBbUQ7QUF1Qm5EOzs7R0FHRztBQUNILE1BQWEsVUFBVTtJQVluQixZQUFZLElBQVksRUFBRSxJQUFZLEVBQUUsSUFBWSxFQUFFLE1BQWU7UUFDakUsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7SUFDekIsQ0FBQztDQUNKO0FBbEJELGdDQWtCQztBQUVELE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQztBQUN6QixNQUFNLG9CQUFvQixHQUFHLEVBQUUsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBQzlDLE1BQU0sY0FBYyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7QUFFakMsY0FBYztBQUNkLFNBQXNCLFVBQVUsQ0FDNUIsTUFBc0IsRUFDdEIsVUFBNEI7O1FBRTVCLE1BQU0sRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLEdBQUcsVUFBVSxDQUFDO1FBQ3hDLElBQUksRUFBRSxPQUFPLEVBQUUsR0FBRyxVQUFVLENBQUM7UUFFN0IsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDNUIsTUFBTSxNQUFNLEdBQUcsOEJBQW9CLENBQUMsNkJBQW1CLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3hFLE1BQU0sT0FBTyxHQUFHLElBQUks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